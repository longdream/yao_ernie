# YaoScope 部署指南

## 📦 三种部署方式

### 方式1: 开发模式（需要Python环境）

**适用场景**：开发、调试、快速迭代

```bash
# 1. 安装Python 3.9+
# 2. 创建虚拟环境
cd YaoScope
python -m venv venv
call venv\Scripts\activate.bat

# 3. 安装依赖
pip install -r requirements.txt

# 4. 启动服务
start.bat
```

**优点**：
- ✅ 启动快速
- ✅ 易于调试
- ✅ 可以热重载

**缺点**：
- ❌ 需要Python环境
- ❌ 需要安装依赖
- ❌ 不便于分发

---

### 方式2: 独立EXE（推荐用于分发）

**适用场景**：分发给用户、生产部署、无Python环境的机器

#### 打包步骤

```bash
# 1. 在开发机器上打包
cd YaoScope
build_exe.bat

# 2. 等待打包完成（5-10分钟）
# 3. 获取打包结果
# 位置: YaoScope/dist/YaoScope/
```

#### 部署步骤

```bash
# 1. 复制整个文件夹到目标机器
复制 dist/YaoScope/ 文件夹

# 2. 如果需要OCR功能，复制模型文件
复制 models/ 文件夹到 YaoScope.exe 同级目录

# 3. 运行程序
双击 YaoScope.exe
```

#### 验证部署

```bash
# 1. 检查服务是否启动
# 控制台应显示: [OK] YaoScope Service started successfully

# 2. 访问API文档
浏览器打开: http://127.0.0.1:8765/docs

# 3. 测试API
curl http://127.0.0.1:8765/health
```

**优点**：
- ✅ 零依赖部署
- ✅ 一键启动
- ✅ 便于分发
- ✅ 用户友好

**缺点**：
- ❌ 体积较大（500MB-1GB）
- ❌ 首次启动慢（10-30秒）
- ❌ 更新需要重新打包

---

### 方式3: Docker容器（未实现）

**适用场景**：云部署、跨平台、容器化环境

> 注意：当前版本暂不支持Docker部署，如有需要可以添加。

---

## 🎯 推荐部署方案

### 开发环境
```
使用方式1：开发模式
- 快速启动
- 便于调试
```

### 测试环境
```
使用方式2：独立EXE
- 模拟生产环境
- 验证打包正确性
```

### 生产环境
```
使用方式2：独立EXE
- 稳定可靠
- 易于部署
```

### 用户分发
```
使用方式2：独立EXE
- 用户无需安装Python
- 双击即可运行
```

---

## 📋 部署检查清单

### 打包前检查

- [ ] 所有依赖已安装：`pip list`
- [ ] 服务能正常启动：`start.bat`
- [ ] 所有功能测试通过
- [ ] 模型文件准备就绪
- [ ] 清理临时文件和日志

### 打包检查

- [ ] PyInstaller已安装：`pip install pyinstaller`
- [ ] 打包脚本执行成功：`build_exe.bat`
- [ ] 无错误或警告信息
- [ ] 生成的exe文件存在
- [ ] 目录结构完整

### 部署前检查

- [ ] 复制完整的文件夹（不只是exe）
- [ ] 模型文件已复制（如需要）
- [ ] 目标机器有足够磁盘空间（至少2GB）
- [ ] 端口8765未被占用
- [ ] 防火墙允许程序运行

### 部署后验证

- [ ] 程序能正常启动
- [ ] 控制台无错误信息
- [ ] API文档可以访问
- [ ] 测试几个关键API
- [ ] OCR功能正常（如需要）
- [ ] 日志正常写入

---

## 🔧 常见问题

### Q1: 打包后体积太大怎么办？

**A**: 可以优化：
1. 在 `build_exe.spec` 中排除不需要的包
2. 不打包模型文件，改为外部加载
3. 使用UPX压缩（已启用）
4. 考虑使用Nuitka（更高级的打包工具）

### Q2: 打包后启动很慢？

**A**: 这是正常的：
- 首次启动需要解压临时文件（10-30秒）
- 后续启动会快一些
- 可以考虑使用单文件模式（但会更慢）

### Q3: 目标机器无法运行？

**A**: 检查：
1. 是否复制了完整的文件夹（不只是exe）
2. 是否有杀毒软件拦截
3. 是否缺少VC++运行库（安装 VC++ Redistributable）
4. 查看控制台的具体错误信息

### Q4: 如何更新已部署的程序？

**A**: 
1. 在开发机器上重新打包
2. 备份目标机器的 `data/` 目录
3. 替换整个程序文件夹
4. 恢复 `data/` 目录
5. 重新启动服务

### Q5: 如何自定义配置？

**A**:
- 配置文件：`service/config.py`
- 环境变量：在启动前设置
- API接口：通过 `/config/update` 动态更新

### Q6: 如何查看日志？

**A**:
- 控制台输出：直接查看
- 日志文件：`data/planscope/logs/planscope.log`
- 服务日志：`service/logs/`

---

## 📞 技术支持

### 日志位置

```
YaoScope/
├── data/
│   └── planscope/
│       └── logs/
│           └── planscope.log      # PlanScope日志
├── service/
│   └── logs/                      # 服务日志
└── logs/                          # 其他日志
```

### 调试模式

如果需要更详细的日志，修改 `service/config.py`：

```python
# 启用调试模式
DEBUG = True
LOG_LEVEL = "DEBUG"
```

### 报告问题

如果遇到问题，请提供：
1. 完整的错误信息
2. 控制台输出
3. 日志文件
4. 操作步骤
5. 系统环境（Windows版本、内存等）

---

## 🔄 版本管理

### 版本号规则

```
主版本.次版本.修订版本
例如: 1.0.0
```

### 更新日志

建议维护 `CHANGELOG.md` 记录每次更新：

```markdown
## [1.0.0] - 2025-11-27
### Added
- 初始版本
- 支持独立EXE打包

### Changed
- 优化启动速度

### Fixed
- 修复OCR识别问题
```

---

**最后更新**: 2025-11-27

